<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Track RTI Application</title>
<style>
body {
    margin:0;
    font-family:Arial,sans-serif;
    background:#f1f5f9;
    overflow:hidden;
    height:100vh;
    display:flex;
    flex-direction:column;
}

/* ===== TOP BAR ===== */
.topbar {
    background:#0066ff;
    color:#fff;
    padding:15px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    font-size:18px;
    position:relative;
}
.topbar span { font-weight:bold; cursor:pointer; }
.language-selector {
    display:flex;
    gap:10px;
}
.language-selector span {
    cursor:pointer;
    padding:5px 10px;
    border-radius:6px;
    background:rgba(255,255,255,0.2);
    transition:0.2s;
}
.language-selector span.active {
    background:#fff;
    color:#0066ff;
    font-weight:bold;
}

/* ===== MENU ===== */
.menu {
    position:absolute;
    top:60px;
    left:0;
    width:200px;
    background:white;
    box-shadow:2px 2px 10px rgba(0,0,0,0.2);
    display:none;
    flex-direction:column;
    border-radius:0 0 10px 10px;
    z-index:1000;
}
.menu div {
    padding:15px;
    border-bottom:1px solid #eee;
    cursor:pointer;
}
.menu div:hover { background:#f0f0f0; }

/* ===== MAIN CONTENT ===== */
.main-content {
    flex:1;
    overflow-y:auto;
    padding-bottom:70px;
}

/* ===== KPI CARDS ===== */
.kpi-container {
    display:flex;
    overflow-x:auto;
    padding:10px;
    gap:10px;
}
.kpi-card {
    min-width:140px;
    background:white;
    padding:15px;
    border-radius:12px;
    box-shadow:0px 2px 8px rgba(0,0,0,0.2);
    flex-shrink:0;
    transition:transform 0.2s;
}
.kpi-card:hover { transform:translateY(-3px); }
.kpi-title { font-size:14px; color:#555; }
.kpi-value { font-size:22px; font-weight:bold; margin-top:5px; }

/* ===== SEARCH & FILTER ===== */
.search-box {
    margin:15px;
}
.search-box input {
    width:100%;
    padding:12px;
    border-radius:10px;
    border:none;
    box-shadow:0px 2px 6px rgba(0,0,0,0.15);
    margin-bottom:10px;
}
.filter-tabs { display:flex; justify-content:space-around; gap:5px; margin:0 15px 15px 15px; }
.filter-tabs button {
    flex:1; padding:10px; border:none; border-radius:10px;
    background:#0066ff; color:white; font-weight:bold; cursor:pointer; transition:0.2s;
}
.filter-tabs button:hover { background:#004bb5; }

/* ===== RTI LIST ===== */
#rtiList {
    padding: 0 15px;
}
.rti-card {
    background:white;
    margin:10px 0;
    padding:15px;
    border-radius:12px;
    box-shadow:0px 2px 6px rgba(0,0,0,0.15);
    transition:transform 0.2s;
}
.rti-card:hover { transform:translateY(-2px); }
.rti-card div { margin:5px 0; }
.rti-status {
    float:right;
    font-weight:bold;
    padding:3px 8px;
    border-radius:12px;
    font-size:12px;
    color:#fff;
}
.pending { background:#ff4d4d; }
.processing { background:#ff9933; }
.resolved { background:#33cc33; }

/* ===== PROGRESS BAR ===== */
.progress-container {
    background: #eee;
    border-radius: 10px;
    height: 8px;
    margin-top: 8px;
    overflow: hidden;
}
.progress-bar {
    height: 8px;
    border-radius: 10px;
    transition: width 0.3s;
}
.progress-pending { width: 20%; background: #ff4d4d; }
.progress-processing { width: 60%; background: #ff9933; }
.progress-resolved { width: 100%; background: #33cc33; }

/* ===== ACTION BUTTONS ===== */
.rti-actions {
    display:flex;
    gap:10px;
    margin-top:10px;
}
.rti-actions a {
    flex:1;
    text-align:center;
    background:#0066ff;
    color:white;
    padding:12px 0;
    border-radius:12px;
    font-size:16px;
    text-decoration:none;
    transition:background 0.2s, transform 0.2s;
}
.rti-actions a:hover { background:#004bb5; transform:translateY(-2px); }

/* ===== LOADING ===== */
#loading { text-align:center; margin:30px 0; color:#0066ff; font-weight:bold; }

/* ===== BOTTOM NAV ===== */
.bottom-nav {
    position:fixed;
    bottom:0;
    left:0;
    width:100%;
    background:white;
    display:flex;
    justify-content:space-around;
    padding:12px 0;
    box-shadow:0px -2px 8px rgba(0,0,0,0.15);
    z-index:100;
}
.bottom-nav div { text-align:center; font-size:14px; cursor:pointer; }
.bottom-nav .active { color:#0066ff; font-weight:bold; }

/* ===== RESPONSIVE ===== */
@media(max-width:400px) {
    .rti-actions a { font-size:14px; padding:10px 0; }
    .menu { width:150px; }
    .kpi-card { min-width:120px; }
}
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
    <div id="menuToggle">‚ò∞ Menu</div>
    <span id="dashboardTitle">Track RTI Application</span>
    <div class="language-selector">
        <span id="langEN" class="active" onclick="setLanguage('en')">EN</span>
        <span id="langHI" onclick="setLanguage('hi')">‡§π‡§ø‡§Ç‡§¶‡•Ä</span>
    </div>
</div>

<!-- DROPDOWN MENU -->
<div class="menu" id="menuItems">
    <div onclick="location.href='dashboard.html'">üìä Dashboard</div>
    <div onclick="location.href='form.html'">üìÇ File RTI</div>
    <div onclick="logout()">üö™ Logout</div>
</div>

<!-- MAIN CONTENT -->
<div class="main-content">
    <!-- KPI CARDS -->
    <div class="kpi-container">
        <div class="kpi-card">
            <div class="kpi-title" data-en="Total RTIs" data-hi="‡§ï‡•Å‡§≤ ‡§Ü‡§∞‡§ü‡•Ä‡§Ü‡§à">Total RTIs</div>
            <div class="kpi-value" id="totalRTIs">0</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-title" data-en="Pending" data-hi="‡§≤‡§Ç‡§¨‡§ø‡§§">Pending</div>
            <div class="kpi-value" id="pendingRTIs">0</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-title" data-en="Processing" data-hi="‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§Æ‡•á‡§Ç">Processing</div>
            <div class="kpi-value" id="processingRTIs">0</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-title" data-en="Resolved" data-hi="‡§∏‡•Å‡§≤‡§ù‡§æ ‡§π‡•Å‡§Ü">Resolved</div>
            <div class="kpi-value" id="resolvedRTIs">0</div>
        </div>
    </div>

    <!-- SEARCH & FILTER -->
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="Search by Application ID" data-en="Search by Application ID" data-hi="‡§Ü‡§µ‡•á‡§¶‡§® ‡§Ü‡§à‡§°‡•Ä ‡§∏‡•á ‡§ñ‡•ã‡§ú‡•á‡§Ç">
    </div>
    <div class="filter-tabs">
        <button onclick="filterStatus('all')" data-en="All" data-hi="‡§∏‡§≠‡•Ä">All</button>
        <button onclick="filterStatus('pending')" data-en="Pending" data-hi="‡§≤‡§Ç‡§¨‡§ø‡§§">Pending</button>
        <button onclick="filterStatus('processing')" data-en="Processing" data-hi="‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§Æ‡•á‡§Ç">Processing</button>
        <button onclick="filterStatus('resolved')" data-en="Resolved" data-hi="‡§∏‡•Å‡§≤‡§ù‡§æ ‡§π‡•Å‡§Ü">Resolved</button>
    </div>

    <!-- LOADING -->
    <div id="loading">Loading...</div>

    <!-- RTI APPLICATION LIST -->
    <div id="rtiList"></div>
</div>

<!-- BOTTOM NAV -->
<div class="bottom-nav">
    <div onclick="location.href='dashboard.html'" class="active" data-en="Home" data-hi="‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§™‡•É‡§∑‡•ç‡§†">üè† Home</div>
    <div onclick="location.href='track.html'" data-en="My RTIs" data-hi="‡§Æ‡•á‡§∞‡•á ‡§Ü‡§∞‡§ü‡•Ä‡§Ü‡§à">üìÑ My RTIs</div>
    <div onclick="location.href='profile.html'" data-en="Profile" data-hi="‡§™‡•ç‡§∞‡•ã‡§´‡§º‡§æ‡§á‡§≤">üë§ Profile</div>
</div>

<script src="https://api.backendless.com/sdk/js/latest/backendless.min.js"></script>
<script>
const APP_ID = "A1EFA0A2-9F5F-4AB4-B41A-34610BD8119F";
const JS_API_KEY = "F7F4D0E1-9677-4715-8C0E-F1FD819B9D69";
Backendless.initApp(APP_ID, JS_API_KEY);

// MENU TOGGLE
const menuToggle = document.getElementById("menuToggle");
const menuItems = document.getElementById("menuItems");
menuToggle.onclick = () => { menuItems.style.display = menuItems.style.display==="flex"?"none":"flex"; }

// LOGOUT
function logout(){
    Backendless.UserService.logout().then(()=>{ localStorage.clear(); location.href='index.html'; });
}

// ALL APPLICATIONS
let allApplications = [];

// FETCH RTIs
async function fetchRTIs(){
    document.getElementById("loading").style.display="block";
    try{
        const currentUser = await Backendless.UserService.getCurrentUser();
        if(!currentUser) return;
        const whereClause = `email = '${currentUser.email}'`;
        allApplications = await Backendless.Data.of("RTI_Forms").find({where:whereClause});
        renderList(allApplications);
        updateKPIs();
        setupRealtime(currentUser.email);
    }catch(err){ console.error(err); }
    document.getElementById("loading").style.display="none";
}

// RENDER LIST
function renderList(list){
    const container = document.getElementById("rtiList");
    container.innerHTML="";
    list.forEach(a=>{
        const card = document.createElement("div");
        card.className="rti-card";
        card.innerHTML=`
            <div><b>${a.regNo}</b>
                <span class="rti-status ${a.status.toLowerCase()}">${a.status.toUpperCase()}</span>
            </div>
            <div>Department: ${a.department}</div>
            <div>Filed On: ${new Date(a.createdAt).toLocaleDateString()}</div>
            <div>Last Update: ${new Date(a.updatedAt).toLocaleDateString()}</div>
            <div class="progress-container">
                <div class="progress-bar progress-${a.status.toLowerCase()}"></div>
            </div>
            <div class="rti-actions">
                <a href="details.html?id=${a.objectId}" data-en="View Details" data-hi="‡§µ‡§ø‡§µ‡§∞‡§£ ‡§¶‡•á‡§ñ‡•á‡§Ç">View Details</a>
                ${a.status.toLowerCase()!=="resolved"?`<a href="appeal.html?id=${a.objectId}" data-en="File Appeal" data-hi="‡§Ö‡§™‡•Ä‡§≤ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç">File Appeal</a>`:''}
            </div>
        `;
        container.appendChild(card);
    });
}

// SEARCH
document.getElementById("searchInput").addEventListener("input",e=>{
    const query=e.target.value.toLowerCase();
    renderList(allApplications.filter(a=>a.regNo.toLowerCase().includes(query)));
});

// FILTER STATUS
function filterStatus(status){
    if(status==='all') renderList(allApplications);
    else renderList(allApplications.filter(a=>a.status.toLowerCase()===status));
}

// UPDATE KPI CARDS
function updateKPIs(){
    document.getElementById("totalRTIs").innerText = allApplications.length;
    document.getElementById("pendingRTIs").innerText = allApplications.filter(a=>a.status.toLowerCase()==="pending").length;
    document.getElementById("processingRTIs").innerText = allApplications.filter(a=>a.status.toLowerCase()==="processing").length;
    document.getElementById("resolvedRTIs").innerText = allApplications.filter(a=>a.status.toLowerCase()==="resolved").length;
}

// REALTIME UPDATES
async function setupRealtime(userEmail){
    const whereClause = `email='${userEmail}'`;
    const rt = Backendless.Data.of("RTI_Forms").rt();
    rt.addCreateListener(whereClause,record=>{ allApplications.push(record); renderList(allApplications); updateKPIs(); });
    rt.addUpdateListener(whereClause,record=>{ const i=allApplications.findIndex(a=>a.objectId===record.objectId); if(i!==-1){ allApplications[i]=record; renderList(allApplications); updateKPIs(); } });
    rt.addDeleteListener(whereClause,record=>{ allApplications=allApplications.filter(a=>a.objectId!==record.objectId); renderList(allApplications); updateKPIs(); });
}

// LANGUAGE SWITCH
function setLanguage(lang){
    document.getElementById('langEN').classList.toggle('active', lang==='en');
    document.getElementById('langHI').classList.toggle('active', lang==='hi');
    document.querySelectorAll('[data-en]').forEach(el=>{
        if(el.tagName==='INPUT' && el.hasAttribute('placeholder')){
            el.placeholder = lang==='en'?el.getAttribute('data-en'):el.getAttribute('data-hi');
        }else el.innerText = lang==='en'?el.getAttribute('data-en'):el.getAttribute('data-hi');
    });
}

// INITIAL FETCH
fetchRTIs();
</script>
</body>
</html>