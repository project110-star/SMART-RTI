<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Officer Panel - Smart RTI</title>
<style>
  * { box-sizing: border-box; margin:0; padding:0; font-family:'Poppins',sans-serif; }
  body { background: linear-gradient(135deg,#74ebd5,#ACB6E5); min-height:100vh; display:flex; justify-content:center; align-items:flex-start; padding:20px; }

  .container {
    width:100%;
    max-width:1000px;
    background: rgba(0,0,0,0.85);
    color:#fff;
    border-radius:20px;
    padding:25px;
    box-shadow:0 10px 40px rgba(0,0,0,0.5);
  }

  .logout-btn {
    float:right;
    background:#ff4b5c;
    color:white;
    border:none;
    padding:10px 20px;
    border-radius:12px;
    cursor:pointer;
    font-weight:bold;
    margin-bottom:20px;
    transition:0.3s;
  }
  .logout-btn:hover { background:#ff2b3c; }

  h2 { text-align:center; margin-bottom:25px; color:#fff; text-shadow: 1px 1px 3px #000; }

  .table-wrapper { overflow-x:auto; }
  table { width:100%; border-collapse:collapse; min-width:700px; }
  th, td { padding:12px 10px; text-align:center; border-bottom:1px solid rgba(255,255,255,0.3); color:#fff; white-space:nowrap; }
  th { background: linear-gradient(90deg, #ff7e5f, #feb47b); color:#000; font-weight:bold; }
  tbody tr:hover { background: rgba(255,255,255,0.1); transform: scale(1.01); transition:0.2s; }

  /* Make Department wider */
  th:nth-child(3), td:nth-child(3) { min-width:180px; }

  /* Status badges */
  .status-pending { color:#ffc107; font-weight:bold; }
  .status-replied { color:#28a745; font-weight:bold; }
  .status-closed { color:#6c757d; font-weight:bold; }

  /* Buttons */
  button.view-btn, button.update-btn, button.delete-btn, button.close-btn-modal {
    border:none; padding:6px 12px; border-radius:8px; cursor:pointer; font-weight:bold; transition:0.3s; box-shadow:0 3px 6px rgba(0,0,0,0.2);
  }
  button.view-btn { background:#ff9800; color:white; }
  button.view-btn:hover { background:#e67e22; }
  button.update-btn { background:#007BFF; color:white; }
  button.update-btn:hover { background:#0056b3; }
  button.delete-btn { background:#dc3545; color:white; }
  button.delete-btn:hover { background:#a71d2a; }
  button.close-btn-modal { background:#6c757d; color:white; }
  button.close-btn-modal:hover { background:#495057; }

  /* Modal */
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); justify-content:center; align-items:center; z-index:100; padding:10px; }
  .modal-content { background:#fff; color:#333; padding:25px; border-radius:20px; width:95%; max-width:600px; max-height:90vh; overflow-y:auto; box-shadow:0 10px 40px rgba(0,0,0,0.4); }
  .modal-content h3 { margin-bottom:15px; }
  .modal-content p { margin-bottom:10px; }

  /* Mobile responsive */
  @media(max-width:600px){
    table, th, td, tr { display:block; width:100%; }
    tr { margin-bottom:15px; border-bottom:2px solid rgba(255,255,255,0.2); }
    td { text-align:right; padding-left:50%; position:relative; color:#fff; }
    td::before { content: attr(data-label); position:absolute; left:10px; top:12px; font-weight:bold; color:#fff; text-align:left; }
    th { display:none; }
  }
</style>
</head>
<body>

<div class="container">
  <button class="logout-btn" onclick="logout()">Logout</button>
  <h2>Officer Panel</h2>

  <div class="table-wrapper">
    <table id="rtiTable">
      <thead>
        <tr>
          <th>Reg No</th>
          <th>Name</th>
          <th>Department</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <!-- JS will populate rows -->
      </tbody>
    </table>
  </div>
</div>

<div id="rtiDetailModal" class="modal">
  <div class="modal-content">
    <span class="close-btn-modal" onclick="closeRTIModal()">Close</span>
    <div id="rtiDetails"></div>
    <div style="margin-top:15px;">
      <button class="update-btn" id="updateStatusBtn">Update Status</button>
      <button class="delete-btn" id="deleteRTIBtn">Delete RTI</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/backendless/dist/backendless.min.js"></script>
<script>
Backendless.initApp("A1EFA0A2-9F5F-4AB4-B41A-34610BD8119F","F7F4D0E1-9677-4715-8C0E-F1FD819B9D69");

const rtiTableBody = document.querySelector("#rtiTable tbody");
const modal = document.getElementById("rtiDetailModal");
const rtiDetailsDiv = document.getElementById("rtiDetails");
let selectedRTI = null;

// Load RTIs
async function loadOfficerPanel(){
  try {
    const list = await Backendless.Data.of("RTI_Forms").find();
    rtiTableBody.innerHTML = "";
    list.forEach(rti => {
      const tr = document.createElement("tr");
      const statusClass = "status-" + (rti.status || "pending").toLowerCase();
      tr.innerHTML = `
        <td data-label="Reg No">${rti.regNo || ""}</td>
        <td data-label="Name">${rti.name || ""}</td>
        <td data-label="Department">${rti.department || ""}</td>
        <td data-label="Status" class="${statusClass}">${(rti.status || "pending").toUpperCase()}</td>
        <td data-label="Action"><button class="view-btn" onclick="viewRTI('${rti.objectId}')">View</button></td>
      `;
      rtiTableBody.appendChild(tr);
    });
  } catch(err){ console.error(err); alert("Failed to load RTIs: " + err.message); }
}

// View RTI modal
async function viewRTI(id){
  try {
    selectedRTI = await Backendless.Data.of("RTI_Forms").findById(id);
    rtiDetailsDiv.innerHTML = `
      <h3>${selectedRTI.subject || "No Subject"}</h3>
      <p><b>Reg No:</b> ${selectedRTI.regNo || ""}</p>
      <p><b>Name:</b> ${selectedRTI.name || ""}</p>
      <p><b>Department:</b> ${selectedRTI.department || ""}</p>
      <p><b>Status:</b> <span class="status-${selectedRTI.status.toLowerCase()}">${selectedRTI.status || ""}</span></p>
      <p><b>RTI Text:</b> ${selectedRTI.rtiText || ""}</p>
    `;
    modal.style.display = "flex";
  } catch(err){ console.error(err); alert("Failed to fetch RTI: " + err.message); }
}

function closeRTIModal(){ modal.style.display = "none"; selectedRTI=null; }

document.getElementById("updateStatusBtn").onclick = async ()=>{
  if(!selectedRTI) return alert("No RTI selected");
  const newStatus = prompt("Enter new status (pending/replied/closed):", selectedRTI.status);
  if(!newStatus) return;
  try {
    selectedRTI.status = newStatus.toLowerCase();
    await Backendless.Data.of("RTI_Forms").save(selectedRTI);
    alert("Status updated!");
    closeRTIModal();
    loadOfficerPanel();

    // Update dashboard if open
    if(window.opener && window.opener.loadDashboard){
      window.opener.loadDashboard();
    }

  } catch(err){ alert("Update failed: "+err.message); }
}

document.getElementById("deleteRTIBtn").onclick = async ()=>{
  if(!selectedRTI) return alert("No RTI selected");
  if(!confirm("Are you sure to delete this RTI?")) return;
  try{
    await Backendless.Data.of("RTI_Forms").remove(selectedRTI);
    alert("RTI deleted!");
    closeRTIModal();
    loadOfficerPanel();

    // Update dashboard if open
    if(window.opener && window.opener.loadDashboard){
      window.opener.loadDashboard();
    }

  }catch(err){ alert("Delete failed: "+err.message); }
}

function logout(){
  Backendless.UserService.logout().then(()=>{
    localStorage.clear();
    window.location.href = "login.html";
  });
}

window.onload = loadOfficerPanel;
</script>
</body>
</html>